#Jenkins X lacks "onFailure" steps. For this reason, we are forced to let the main build succeed, stash the build output
#to our DevOps results storage in Github, and then inspect the build output to fail if our fail fast criteria have
#not been met.
#Currently we only check for Failsafe or Surefire failures, but we may want to extend this to fail on other criteria too
jx step stash --pattern="target/site/*" --to-path=${REPO_NAME}/$1 -c reports --basedir=target/site
if grep -rnw target/surefire-reports/*.xml -e "<failure" >/dev/null 2>&1 || grep -rnw target/surefire-reports/*.xml -e "<error" >/dev/null 2>&1; then
  echo >&2 "Unit tests failed for ${REPO_NAME}-$1."
  FAILED_CHECKS="Unit tests; "
fi
if grep -rnw target/failsafe-reports/*.xml -e "<failure" >/dev/null 2>&1 || grep -rnw target/failsafe-reports/*.xml -e "<error" >/dev/null 2>&1; then
  echo >&2 "Integration tests failed for ${REPO_NAME}-$1."
  FAILED_CHECKS="${FAILED_CHECKS}Integration tests; "
fi
if grep -rnw target/checkstyle-result.xml -e "<error" >/dev/null 2>&1; then
  echo >&2 "Checkstyle rules were violated for ${REPO_NAME}-$1."
  FAILED_CHECKS="${FAILED_CHECKS}Checkstyle; "
fi
if grep -rnw target/site/dependency-check-junit.xml -e "<failure" >/dev/null 2>&1; then
  echo >&2 "OWASP has found dependencies with vulnerabilities for ${REPO_NAME}-$1."
  FAILED_CHECKS="${FAILED_CHECKS}OWASP Maven Dependency Check; "
fi
if [ -z "${FAILED_CHECKS}" ]; then
  echo "Congratulations! No build failures found for ${REPO_NAME}-$1."
else
  echo >&2 "The following checks failed: for ${REPO_NAME}-$1 : ${FAILED_CHECKS}"
  exit 1
fi


