buildPack: maven-java11
pipelineConfig:
  agent:
    image: maven-java11
  env:
  - name: _JAVA_OPTIONS
    value: -XX:+UnlockExperimentalVMOptions -Dsun.zip.disableMemoryMapping=true -XX:+UseParallelGC -XX:MinHeapFreeRatio=5 -XX:MaxHeapFreeRatio=10 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90 -Xms10m -Xmx512m
  - name: GPG_PASSPHRASE
    valueFrom:
      secretKeyRef:
         name: jenkins-release-gpg
         key: passphrase
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: mvn versions:set -DnewVersion=$PREVIEW_VERSION
            name: set-version
          - command:  mvn
            args:
              - clean
              - verify
              - sonar:sonar
              - -Dsonar.login=df542e4786884a893b2e776bfa9427e5df55e807
              - -Dsonar.pullrequest.key=${PULL_NUMBER}
              - -Dsonar.scm.revision=${PULL_BASE_SHA}
              - -DautoUpdate=false
              - -DconnectionString=jdbc:postgresql://172.30.80.197:5432/owasp
              - -DdatabasePassword=owasp
              - -DdatabaseUser=owasp
            name: mvn-verify
    release:
      build:
        replace: true
        steps:
          - command: mvn
            args:
              - clean
              - deploy
              - sonar:sonar
              - -Pprepare-for-central
              - -Dsonar.login=df542e4786884a893b2e776bfa9427e5df55e807
              - -DautoUpdate=false
              - -DconnectionString=jdbc:postgresql://172.30.80.197:5432/owasp
              - -DdatabasePassword=owasp
              - -DdatabaseUser=owasp
              - -Dgpg.homedir=/home/jenkins/.gnupg
              - -Dgpg.keyname=entando-jx
              - -Dgpg.passphrase=${GPG_PASSPHRASE}
            name: mvn-deploy