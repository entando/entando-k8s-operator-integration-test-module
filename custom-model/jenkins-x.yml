buildPack: maven-java11
pipelineConfig:
  agent:
    image: maven-java11
  env:
    - name: _JAVA_OPTIONS
      value: -XX:+UnlockExperimentalVMOptions -Dsun.zip.disableMemoryMapping=true -XX:+UseParallelGC -XX:MinHeapFreeRatio=5 -XX:MaxHeapFreeRatio=10 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90 -Xms10m -Xmx512m
    - name: SONAR_TOKEN
      valueFrom:
        secretKeyRef:
          name: entando-jx-common-secret
          key: sonar.token
    - name: OWASPDB_USERNAME
      valueFrom:
        secretKeyRef:
          name: entando-jx-common-secret
          key: owaspdb.username
    - name: OWASPDB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: entando-jx-common-secret
          key: owaspdb.password
    - name: OWASPDB_URL
      valueFrom:
        secretKeyRef:
          name: entando-jx-common-secret
          key: owaspdb.url
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: mvn versions:set -DnewVersion=$PREVIEW_VERSION
            name: set-version
          - command:  mvn
            args:
              - clean
              - verify
              - sonar:sonar
              - -Dsonar.login=${SONAR_TOKEN}
              - -Dsonar.pullrequest.key=${PULL_NUMBER}
              - -Dsonar.scm.revision=${PULL_BASE_SHA}
              - -DautoUpdate=false
              - -DconnectionString=${OWASPDB_URL}
              - -DdatabasePassword=${OWADPDB_PASSWORD}
              - -DdatabaseUser=${OWASPDB_USERNAME}
            name: mvn-verify
    release:

      build:
        replace: true
        steps:
          - command: mvn
            args:
              - clean
              - deploy
              - sonar:sonar
              - -Pprepare-for-central
              - -Dsonar.login=${SONAR_TOKEN}
              - -DautoUpdate=false
              - -DconnectionString=${OWASPDB_URL}
              - -DdatabasePassword=${OWADPDB_PASSWORD}
              - -DdatabaseUser=${OWASPDB_USERNAME}
              - -Dgpg.homedir=${GPG_HOMEDIR}
              - -Dgpg.keyname=${GPG_KEYNAME}
              - -Dgpg.passphrase=${GPG_PASSPHRASE}
            name: mvn-deploy
            env:
              - name: GPG_PASSPHRASE
                valueFrom:
                  secretKeyRef:
                    name: entando-jx-common-secret
                    key: gpg.passphrase
              - name: GPG_KEYNAME
                valueFrom:
                  secretKeyRef:
                    name: entando-jx-common-secret
                    key: gpg.keyname
              - name: GPG_HOMEDIR
                valueFrom:
                  secretKeyRef:
                    name: entando-jx-common-secret
                    key: gpg.homedir