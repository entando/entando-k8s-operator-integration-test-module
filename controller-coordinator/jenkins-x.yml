buildPack: maven-java11
pipelineConfig:
  agent:
    image: entando-jx-maven-java11
  env:
    - name: PIPELINE_CODE
      value: co
    - name: _JAVA_OPTIONS
      value: -XX:+UnlockExperimentalVMOptions -Dsun.zip.disableMemoryMapping=true -XX:+UseParallelGC -XX:MinHeapFreeRatio=5 -XX:MaxHeapFreeRatio=10 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90 -Xms1000m -Xmx12000m
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - sh: mvn versions:set -DnewVersion=$PREVIEW_VERSION
            name: set-version
          - sh: fix-git-branches
            name: fix-git-for-sonar
          - sh: mvn-verify-pr -P${EXECUTABLE_TYPE}
            name: mvn-verify-pr
          - sh:  echo "This avoids unwanted kaniko command substitution" &&  skaffold build -p ${EXECUTABLE_TYPE} -f skaffold.yaml
            name: container-build
      promote:
        replace: true
        steps:
          - dir: charts/preview
            steps:
              - sh: make preview
                name: make-preview
              - sh: jx preview --name ${REPO_NAME}-${PIPELINE_CODE}pr${PULL_NUMBER} --app $APP_NAME --dir ../.. --namespace ${REPO_NAME}-${PIPELINE_CODE}pr${PULL_NUMBER}
                name: jx-preview
          - sh: run-inter-process-tests
            name: run-inter-process-tests
    release:
      build:
        replace: true
        steps:
          - sh: fetch-history-by-days 30
            name: fetch-history-for-sonar
          - sh: mvn-deploy-release -P${EXECUTABLE_TYPE}
            name: mvn-deploy-release
          - sh: echo "This avoids unwanted kaniko command substitution"  &&  skaffold build -p ${EXECUTABLE_TYPE} -f skaffold.yaml
            name: container-build
      postBuild:
        replace: true
        steps:
          - sh: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:\$(cat VERSION)
            name: post-build
          - dir: charts/preview
            steps:
              - sh: make preview
                name: make-preview
              - sh: jx preview --name ${REPO_NAME}-${PIPELINE_CODE}ms --app $APP_NAME --dir ../.. --namespace ${REPO_NAME}-${PIPELINE_CODE}ms
                name: jx-preview
          - sh: run-inter-process-tests
            name: run-inter-process-tests
      promote:
        replace: true
        steps:
        - dir: charts/entando-k8s-controller-coordinator
          steps:
            - sh: jx step changelog --generate-yaml=false --version v\$(cat ../../VERSION)
              name: changelog
            - comment: release the helm chart
              sh: jx step helm release
              name: helm-release
            - comment: promote through all 'Auto' promotion Environments
              sh: jx promote -b --all-auto --timeout 1h --version \$(cat ../../VERSION)
              name: jx-promote
        - sh: publish-image-info
          name: update-image-map